<!DOCTYPE html>
<html>

<head>
    <title>Frame skip/latency test and counter</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            background: black;
        }

        * {
            color: white;
            font-family: monospace;
            font-weight: bold;
        }

        #settings {
            width: 100vw;
            height: 32px;
            overflow: hidden;
            font-size: 16px;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            padding: 5px;
            box-sizing: border-box;
        }

        .box {
            display: inline-block;
            width: 10vw;
            height: 9.5vh;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        #boxes {
            font-size: 80px;
            width: 100vw;
            height: 95vh;
            padding-top: 5vh;
        }

        input[type=text] {
            width: 32px;
            text-align: right;
        }

        button {
            width: 80px;
        }

        input,
        button {
            background: black;
            border: 1px solid #555;
            font-size: 16px;
        }

        #fps2 {
            display: inline-block;
            width: 32px;
            text-align: right;
        }
    </style>
</head>

<body>
    <div id="boxes"></div>
    <div id="settings"><label for="fps">FPS: <input type="text" id="fps" size="3" value="60" /></label> / <label
            for="auto"><input type="checkbox" id="auto" checked>Auto</label> | Current FPS:<span id="fps2"></span> |
        <label for="trail"><input type="checkbox" id="trail" checked>Trail</label> |
        <button id="start">Start</button> / <button id="stop">Stop</button> |
        For best results, use Auto and a Blink-based browser in fullscreen.
        That might actually sync to the current monitor.
    </div>
    <script>
        var enabled = false;
        var times = [];
        var frame = 100;
        var count = 0;
        var boxes = document.getElementById("boxes");
        var timer;

        function interval(duration, fn) {
            var _this = this
            this.baseline = undefined

            this.run = function () {
                if (_this.baseline === undefined) {
                    _this.baseline = new Date().getTime()
                }
                fn()
                var end = new Date().getTime()
                _this.baseline += duration

                var nextTick = duration - (end - _this.baseline)
                if (nextTick < 0) {
                    nextTick = 0
                }

                _this.timer = setTimeout(function () {
                    _this.run(end)
                }, nextTick)
            }

            this.cancel = function () {
                clearTimeout(_this.timer)
            }
        }

        const nextFrame = () => {
            const now = performance.now();
            while (times.length > 0 && times[0] <= now - 1000) {
                times.shift();
            }
            times.push(now);
            document.getElementById("fps2").innerHTML = times.length;

            if (count >= 100) {
                count = 0;
                boxes.innerHTML = "";
            }
            var box = document.createElement("div");
            box.className = "box";
            box.innerHTML = frame;
            document.querySelectorAll('.box').forEach((box) => {
                box.style.color = document.getElementById("trail").checked ? "#200000" : "#000";
            });
            boxes.append(box);
            if (++frame > 999)
                frame = 100;
            ++count;
        }
        const animateFrame = () => {
            window.requestAnimationFrame(nextFrame);
        }
        const refreshLoop = () => {
            if (enabled && document.getElementById("auto").checked) {
                window.requestAnimationFrame(() => {
                    nextFrame();
                    refreshLoop();
                });
            }
        }
        document.getElementById("start").onclick = () => {
            if (enabled)
                return;
            enabled = true;
            boxes.style.fontSize = parseInt(document.documentElement.clientWidth / 24) + "px";
            boxes.innerHTML = "";
            frame = 100;
            count = 0;
            times = [];
            if (document.getElementById("auto").checked) {
                refreshLoop();
            } else {
                if (timer)
                    timer.cancel();
                timer = new interval(1000 / parseInt(document.getElementById("fps").value), nextFrame);
                timer.run();
            }

        }
        document.getElementById("stop").onclick = () => {
            enabled = false;
            if (timer) {
                timer.cancel();
                timer = undefined;
            }
        }
        document.getElementById("fps").onfocus = () => {
            document.getElementById("stop").click();
            document.getElementById("auto").checked = false;
            document.getElementById("fps").select();
        }
        document.getElementById("fps").onkeypress = (e) => {
            if (e.which == 0xd) {
                document.getElementById("fps").blur();
                document.getElementById("start").click();
            }
        }
        document.getElementById("auto").onchange = () => {
            document.getElementById("stop").click();
        }
        window.onresize = () => {
            boxes.style.fontSize = parseInt(document.documentElement.clientWidth / 24) + "px";
            boxes.style.lineHeight = boxes.style.fontSize;
        }
    </script>
</body>

</html>
